<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mon Budget - Dark Mode</title>
    
    <!-- Meta tags -->
    <meta name="description" content="Gestionnaire de budget personnel.">
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- React & Babel -->
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
</head>
<body class="bg-slate-950 text-slate-100 antialiased">
    <div id="root">
        <!-- Message de chargement initial si JS est lent -->
        <div class="flex items-center justify-center h-screen">
            <div class="text-slate-500 animate-pulse font-mono uppercase tracking-widest text-xs">Initialisation...</div>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-auth.js";
        import { getFirestore, collection, doc, onSnapshot, setDoc, deleteDoc, getDocs, writeBatch } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-firestore.js";

        // Sécurité : Vérification de la config
        const config = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;
        
        window.FirebaseServices = {
            config, initializeApp, getAuth, signInAnonymously, onAuthStateChanged,
            getFirestore, collection, doc, onSnapshot, setDoc, deleteDoc, getDocs, writeBatch
        };

        // Déclencher un événement quand Firebase est prêt
        window.dispatchEvent(new Event('firebase-ready'));
    </script>

    <script type="text/babel">
        const { useState, useEffect, useMemo } = React;

        function App() {
            const [services, setServices] = useState(window.FirebaseServices);
            const [user, setUser] = useState(null);
            const [transactions, setTransactions] = useState([]);
            const [loading, setLoading] = useState(true);
            const [showResetConfirm, setShowResetConfirm] = useState(false);
            const [formData, setFormData] = useState({
                description: '', amount: '', type: 'expense', category: 'Alimentation'
            });

            // Attendre que Firebase soit injecté dans window
            useEffect(() => {
                const handleReady = () => setServices(window.FirebaseServices);
                window.addEventListener('firebase-ready', handleReady);
                return () => window.removeEventListener('firebase-ready', handleReady);
            }, []);

            useEffect(() => {
                if (!services || !services.config) return;

                const app = services.initializeApp(services.config);
                const auth = services.getAuth(app);
                const db = services.getFirestore(app);
                const appId = typeof __app_id !== 'undefined' ? __app_id : 'budget-app';

                services.signInAnonymously(auth).catch(console.error);
                
                const unsubAuth = services.onAuthStateChanged(auth, (currUser) => {
                    setUser(currUser);
                    if (currUser) {
                        const q = services.collection(db, 'artifacts', appId, 'users', currUser.uid, 'transactions');
                        const unsubSnap = services.onSnapshot(q, (snapshot) => {
                            const data = snapshot.docs.map(d => ({ id: d.id, ...d.data() }));
                            setTransactions(data.sort((a, b) => b.timestamp - a.timestamp));
                            setLoading(false);
                        }, (err) => {
                            console.error("Firestore error:", err);
                            setLoading(false);
                        });
                        return () => unsubSnap();
                    }
                });

                return () => unsubAuth();
            }, [services]);

            // Actions
            const handleAdd = async (e) => {
                e.preventDefault();
                if (!user || !formData.description || !formData.amount) return;
                const db = services.getFirestore();
                const appId = typeof __app_id !== 'undefined' ? __app_id : 'budget-app';
                const docRef = services.doc(services.collection(db, 'artifacts', appId, 'users', user.uid, 'transactions'));
                await services.setDoc(docRef, {
                    ...formData,
                    amount: parseFloat(formData.amount),
                    timestamp: Date.now()
                });
                setFormData({ ...formData, description: '', amount: '' });
            };

            const stats = useMemo(() => {
                return transactions.reduce((acc, t) => {
                    if (t.type === 'income') { acc.inc += t.amount; acc.bal += t.amount; }
                    else { acc.exp += t.amount; acc.bal -= t.amount; }
                    return acc;
                }, { inc: 0, exp: 0, bal: 0 });
            }, [transactions]);

            if (loading) return (
                <div className="flex flex-col items-center justify-center h-screen bg-slate-950">
                    <div className="w-8 h-8 border-2 border-blue-500 border-t-transparent rounded-full animate-spin mb-4"></div>
                    <div className="text-slate-500 font-mono text-[10px] uppercase tracking-widest">Chargement du cloud...</div>
                </div>
            );

            return (
                <div className="p-4 md:p-8 max-w-4xl mx-auto animate-in fade-in duration-500">
                    <header className="flex justify-between items-center mb-8">
                        <h1 className="text-2xl font-bold text-white flex items-center gap-2">
                            <span className="text-blue-500">●</span> Mon Budget
                        </h1>
                        <div className="text-[10px] font-mono text-slate-500 bg-slate-900 px-3 py-1 rounded-full">
                            UID: {user?.uid.substring(0,8)}...
                        </div>
                    </header>

                    {/* Résumé */}
                    <div className="grid grid-cols-1 md:grid-cols-3 gap-4 mb-8">
                        <div className="bg-slate-900 p-5 rounded-2xl border border-slate-800">
                            <div className="text-slate-500 text-xs font-bold uppercase mb-1">Solde</div>
                            <div className={`text-xl font-bold ${stats.bal >= 0 ? 'text-white' : 'text-rose-500'}`}>{stats.bal.toFixed(2)} €</div>
                        </div>
                        <div className="bg-slate-900 p-5 rounded-2xl border border-slate-800">
                            <div className="text-emerald-500 text-xs font-bold uppercase mb-1">Entrées</div>
                            <div className="text-xl font-bold">+{stats.inc.toFixed(2)} €</div>
                        </div>
                        <div className="bg-slate-900 p-5 rounded-2xl border border-slate-800">
                            <div className="text-rose-500 text-xs font-bold uppercase mb-1">Sorties</div>
                            <div className="text-xl font-bold">-{stats.exp.toFixed(2)} €</div>
                        </div>
                    </div>

                    <div className="grid grid-cols-1 lg:grid-cols-5 gap-8">
                        {/* Formulaire */}
                        <form onSubmit={handleAdd} className="lg:col-span-2 space-y-4 bg-slate-900 p-6 rounded-2xl border border-slate-800 h-fit sticky top-4">
                            <input 
                                type="text" placeholder="Description" required
                                className="w-full p-3 rounded-xl bg-slate-800 border border-slate-700 outline-none focus:ring-1 focus:ring-blue-500 text-sm"
                                value={formData.description}
                                onChange={e => setFormData({...formData, description: e.target.value})}
                            />
                            <div className="flex gap-2">
                                <input 
                                    type="number" step="0.01" placeholder="0.00" required
                                    className="flex-1 p-3 rounded-xl bg-slate-800 border border-slate-700 outline-none text-sm"
                                    value={formData.amount}
                                    onChange={e => setFormData({...formData, amount: e.target.value})}
                                />
                                <select 
                                    className="bg-slate-800 p-3 rounded-xl border border-slate-700 text-sm"
                                    value={formData.type}
                                    onChange={e => setFormData({...formData, type: e.target.value})}
                                >
                                    <option value="expense">Dépense</option>
                                    <option value="income">Revenu</option>
                                </select>
                            </div>
                            <button className="w-full p-3 bg-blue-600 hover:bg-blue-500 rounded-xl font-bold transition-all text-sm">Ajouter</button>
                        </form>

                        {/* Liste */}
                        <div className="lg:col-span-3 bg-slate-900 rounded-2xl border border-slate-800 overflow-hidden">
                            <div className="p-4 border-b border-slate-800 font-bold text-xs uppercase tracking-widest text-slate-500">Historique</div>
                            <div className="divide-y divide-slate-800">
                                {transactions.length === 0 ? (
                                    <div className="p-12 text-center text-slate-700 italic text-sm text-white">Vide</div>
                                ) : transactions.map(t => (
                                    <div key={t.id} className="p-4 flex justify-between items-center hover:bg-slate-800/20 transition-colors">
                                        <div>
                                            <div className="font-bold text-sm text-white">{t.description}</div>
                                            <div className="text-[10px] text-slate-500">{new Date(t.timestamp).toLocaleDateString()}</div>
                                        </div>
                                        <div className={`font-mono font-bold ${t.type === 'income' ? 'text-emerald-500' : 'text-rose-500'}`}>
                                            {t.type === 'income' ? '+' : '-'} {t.amount.toFixed(2)}€
                                        </div>
                                    </div>
                                ))}
                            </div>
                        </div>
                    </div>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
